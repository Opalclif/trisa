---
title: "Demo"
draft: false
weight: 10
---

## Overview

The demo environment can be run in two different modes:

1. In standalone mode using docker
2. In development mode running locally

Both environments will handle the setup of a root CA, two subordinate issuing CA's and
3 different VASP configuration. The first two VASP certificates are issues by the first
subordinate CA, the third one by the second subordinate CA.


## Standalone Mode

This is the easiest way to get a demo environment up-and-running as the only requirement
is having `docker` and `docker-compose` installed on your system. No additional build tools
are necessary.

Note that the standalone mode does not have the ability to make local code changes and test
drive them locally. To accomplish that, refer to Development Mode below.

### Starting the demo

1. Refer to the [Setup your git directory](/contributing/documentation/) section to checkout the
code repository.
2. Make sure you have `docker` and `docker-compose` installed on your system.
3. Execute `make demo-docker` to spool up the VASP servers

Be patient as your system will download some docker images to setup the PKI environment and
prepare the VASP configurations. Wait until the VASP servers are reporting they are running.

Example output:

```
Creating trisa_vasp1_1 ... done
Creating trisa_vasp2_1 ... done
Creating trisa_vasp3_1 ... done
Attaching to trisa_vasp2_1, trisa_vasp1_1, trisa_vasp3_1
vasp2_1  | time="2019-11-06T17:02:45Z" level=info msg="starting TRISA admin server" component=admin port=":8592" tls=listening
vasp2_1  | time="2019-11-06T17:02:45Z" level=info msg="starting TRISA server" component=grpc port=":8092" tls=listening
vasp1_1  | time="2019-11-06T17:02:45Z" level=info msg="starting TRISA admin server" component=admin port=":8591" tls=listening
vasp1_1  | time="2019-11-06T17:02:45Z" level=info msg="starting TRISA server" component=grpc port=":8091" tls=listening
vasp3_1  | time="2019-11-06T17:02:45Z" level=info msg="starting TRISA admin server" component=admin port=":8593" tls=listening
vasp3_1  | time="2019-11-06T17:02:45Z" level=info msg="starting TRISA server" component=grpc port=":8093" tls=listening
```

Leave this terminal running. Any output generated by the VASP containers will be printed on your screen.  Checkout 
the "Transaction Exchange" paragraph below how to trigger traffic.

### Cleanup

You can terminate the containers by using `CTRL+C`. When you are done test driving the demo environment you can clean
everything up by simply running `make demo-docker-cleanup`.


## Development Mode

The development mode is very similar to the Standalone Mode described above, with the only difference that the code on your
local machine will be used. To be able to run this mode, you will need to have your development environment setup properly first.
Refer to the [Development section](/getting_started/dev/) for more details.

### Setup

As this mode is more flexible and tailored to be used during development, it takes a couple of additional steps which can
be executed separately from each other to be able to develop locally using the demo setup. The steps are:

1. Initialize the PKI environment as explained in the overview above.
2. Initialize the VASP configurations
3. Prepare your `/etc/hosts` file
4. Start (and restart) the VASP servers using your local code

### PKI Environment

To initialize the PKI environment, execute `make pki-dev-init`. The resulting certificates can be found in the directory
`hack/etc/pki/dev/out`. This is only required once.

Example output:

```
2019/11/06 17:30:58 [INFO] generating a new CA key and certificate from CSR
2019/11/06 17:30:58 [INFO] generate received request
2019/11/06 17:30:58 [INFO] received CSR
2019/11/06 17:30:58 [INFO] generating key: rsa-2048
2019/11/06 17:30:58 [INFO] encoded CSR
2019/11/06 17:30:58 [INFO] signed certificate with serial number 359764710305891275363215006319074091388411046281
2019/11/06 17:30:59 [INFO] generate received request
2019/11/06 17:30:59 [INFO] received CSR
2019/11/06 17:30:59 [INFO] generating key: rsa-2048
2019/11/06 17:31:00 [INFO] encoded CSR
2019/11/06 17:31:02 [INFO] signed certificate with serial number 336448881919945689928409804424509488290433562755
2019/11/06 17:31:03 [INFO] generate received request
2019/11/06 17:31:03 [INFO] received CSR
2019/11/06 17:31:03 [INFO] generating key: rsa-2048
2019/11/06 17:31:03 [INFO] encoded CSR
2019/11/06 17:31:05 [INFO] signed certificate with serial number 324094491831031348264189587264902595950544179050
2019/11/06 17:31:07 [INFO] generate received request
2019/11/06 17:31:07 [INFO] received CSR
2019/11/06 17:31:07 [INFO] generating key: rsa-2048
2019/11/06 17:31:07 [INFO] encoded CSR
2019/11/06 17:31:09 [INFO] signed certificate with serial number 103772199174043563903751416274680967299043738918
2019/11/06 17:31:10 [INFO] generate received request
2019/11/06 17:31:10 [INFO] received CSR
2019/11/06 17:31:10 [INFO] generating key: rsa-2048
2019/11/06 17:31:11 [INFO] encoded CSR
2019/11/06 17:31:12 [INFO] signed certificate with serial number 363687821928556513700781888500231552873147929246
2019/11/06 17:31:14 [INFO] generate received request
2019/11/06 17:31:14 [INFO] received CSR
2019/11/06 17:31:14 [INFO] generating key: rsa-2048
2019/11/06 17:31:14 [INFO] encoded CSR
2019/11/06 17:31:16 [INFO] signed certificate with serial number 20094890818264606042704470361038414783018091041
```

### Generate VASP configs

Each VASP server needs its own configuration file. By executing `make demo-init` those are automatically created
for you under the `artifacts/demo/vasp*` directories. You can use those as a reference if you want to manually
spool up a VASP server.

Note that it is advized to use the built-in PKI tooling as also the demo environment requires properly issued
certificates. If you run into any issues down the line regarding TLS authentication errors, you probably need to
re-initialize the PKI environment.

Example VASP config file:

```
tls:
  privateKeyFile: server.key
  certificateFile: server.crt
  trustChain: trust.chain
server:
  listenAddress: :8091
  listenAddressAdmin: :8591
  hostname: vasp1
```

The main `listenAddress` is the port used for the gRPC peer-to-peer communication between the VASPs. The
`listenAddressAdmin` port has a simple HTTP endpoint to trigger transaction exchanges for demo purposes.

Next to the config generation, this step will also produce a binary `artifacts/bin/trisa` which you can use
to spool up a VASP server manually if you feel for it. This binary in combination with the generated config
files will be used by the next step.

### DNS Resolution

As we are simulating multiple VASP servers on your local machine, we will bind them to different port numbers.
However for the mutual TLS authentication to work properly (and be able to test CRL or OSCP), we need to make
use of distinct DNS names for each VASP.

The easiest way is to add the following entries to your `/etc/hosts` file:

```
127.0.0.1 vasp1
127.0.0.1 vasp2
127.0.0.1 vasp3
```

### Starting VASP servers

Now that we are setup, we can use `make demo-run` to start the 3 VASP servers.

Example output:

```
VASP servers started. Log output can be found under github.com/trisacrypto/trisa/artifacts/demo/logs
total 0
-rw-r--r--  1 skymeyer  staff  0 Nov  6 09:43 vasp1.log
-rw-r--r--  1 skymeyer  staff  0 Nov  6 09:43 vasp2.log
-rw-r--r--  1 skymeyer  staff  0 Nov  6 09:43 vasp3.log
```

The log output of each VASP process is redirected to the above mentioned log files which you can tail.
See the next paragraph on how to trigger transaction exchanges.


## Transaction Exchange

The procedure to trigger transaction exchanges is the same for both Standalone as Development mode. Each
VASP has a simplistic HTTP endpoint (admin port) which you can trigger to send a transaction. Note that
the message are currently hardcoded, but you can decide between which VAPs to create the exchange.

The VASPs are using the following ports:

* vasp1: gRPC `:8091`, admin `:8591`
* vasp2: gRPC `:8092`, admin `:8592`
* vasp3: gRPC `:8093`, admin `:8593`

To trigger an exchange from VASP1 to VASP2:

`curl -ks "https://127.0.0.1:8591/send?target=vasp3:8093" > /dev/null`

By changing the admin port number `8592` you can specific which VASP will initiate the exchange. The
`target` parameter specifies to which VASP to send the transaction. To send a transaction from VASP3
to VASP2, use:

`curl -ks "https://127.0.0.1:8593/send?target=vasp2:8092" > /dev/null`

Observer the log output of each VASP server to see how the exchange went.

Example sending VAPS:

```
msg="protocol envelope for incomingtransaction 32b25cb3-7db5-47be-b16a-326116614791" direction=incoming enc_algo=AES256_GCM enc_blob="[...]" hmac="[...]" hmac_algo=HMAC_SHA256
msg="received transaction 32b25cb3-7db5-47be-b16a-326116614791 from vasp1" identity="first_name:\"John\" last_name:\"Doe\" ssn:\"001-0434-4983\" state:\"CA\" driver_license:\"FA-387463\" " identity-type=trisa.identity.us.v1alpha1.Identity network="source:\"38cf76d0-fcb8-4e3a-b5e9-bd65e3f1808b\" destination:\"3412377b-22dd-4f69-a456-9722fce95c8a\" " network-type=trisa.data.bitcoin.v1alpha1.Data
msg="sent transaction response for 32b25cb3-7db5-47be-b16a-326116614791 to vasp1" identity="first_name:\"Jane\" last_name:\"Foe\" national_number:\"109-800211-69\" city_of_birth:\"Zwevezele\" " identity-type=trisa.identity.be.v1alpha1.Identity
msg="protocol envelope for incomingtransaction 32b25cb3-7db5-47be-b16a-326116614791" direction=outgoing enc_algo=AES256_GCM enc_blob="[...]" hmac="[...]" hmac_algo=HMAC_SHA256
```
